# Token æ± ç®¡ç†ç³»ç»Ÿå®ç°æ–‡æ¡£

## æ¦‚è¿°

Token æ± ç®¡ç†ç³»ç»Ÿæ˜¯ä¸ºäº†è§£å†³ Warp API è®¿é—®é¢‘ç‡é™åˆ¶é—®é¢˜è€Œè®¾è®¡çš„æ™ºèƒ½ä»¤ç‰Œç®¡ç†è§£å†³æ–¹æ¡ˆã€‚è¯¥ç³»ç»Ÿé€šè¿‡é¢„å…ˆå‡†å¤‡å¤šä¸ªæœ‰æ•ˆ token å¹¶åœ¨é‡åˆ°é€Ÿç‡é™åˆ¶æ—¶è‡ªåŠ¨åˆ‡æ¢ï¼Œç¡®ä¿ç”¨æˆ·å¯¹è¯ä¸ä¼šè¢«ä¸­æ–­ã€‚

## æ ¸å¿ƒé—®é¢˜

### åŸå§‹é—®é¢˜
1. **IP é™åˆ¶**: Warp æœåŠ¡é™åˆ¶åŒä¸€ IP åœ¨ä¸€å°æ—¶å†…åªèƒ½ç”³è¯·ä¸€ä¸ªåŒ¿å token
2. **429 é”™è¯¯ä¸­æ–­**: å½“é‡åˆ°é€Ÿç‡é™åˆ¶æ—¶ï¼Œä¼ ç»Ÿæ–¹æ³•éœ€è¦é‡æ–°ç”³è¯· tokenï¼Œå¯¼è‡´å½“å‰å¯¹è¯ä¸­æ–­
3. **ç”¨æˆ·ä½“éªŒ**: é¢‘ç¹çš„ä¸­æ–­ä¸¥é‡å½±å“å·¥ä½œæµç¨‹å’Œç”¨æˆ·ä½“éªŒ

### è§£å†³æ–¹æ¡ˆ
1. **Cloudflare Worker**: åˆ©ç”¨ CF çš„åˆ†å¸ƒå¼ IP æ± çªç ´ IP é™åˆ¶
2. **Token æ± **: ç»´æŠ¤ 2-3 ä¸ªé¢„å¤‡ tokenï¼Œå®ç°æ— ç¼åˆ‡æ¢
3. **è‡ªåŠ¨é‡è¯•**: åœ¨è¯·æ±‚å±‚é¢æ‹¦æˆª 429 é”™è¯¯å¹¶è‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨ token é‡è¯•

## ç³»ç»Ÿæ¶æ„

### ç»„ä»¶å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨ç¨‹åºè¯·æ±‚å±‚                          â”‚
â”‚                 warp_request_handler.py                  â”‚
â”‚              (æ‹¦æˆª 429 é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Token æ± ç®¡ç†å±‚                          â”‚
â”‚                  warp_token_pool.py                      â”‚
â”‚         (ç»´æŠ¤ 2-3 ä¸ª tokenï¼Œåå°åˆ·æ–°)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Cloudflare Worker ç®¡ç†å±‚                    â”‚
â”‚                warp_token_manager.py                     â”‚
â”‚         (éƒ¨ç½² Workerï¼Œè·å–åˆ†å¸ƒå¼ IP)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Cloudflare Workers é›†ç¾¤                     â”‚
â”‚              cloudflare-worker.js                       â”‚
â”‚           (åˆ†å¸ƒåœ¨å…¨çƒçš„ Worker å®ä¾‹)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. Cloudflare Worker è„šæœ¬ (`cloudflare-worker.js`)

**åŠŸèƒ½**: åœ¨ Cloudflare è¾¹ç¼˜èŠ‚ç‚¹è¿è¡Œï¼Œä½¿ç”¨ä¸åŒçš„ IP åœ°å€ç”³è¯· token

**å…³é”®å®ç°**:
```javascript
// å›ºå®šçš„è¯·æ±‚é…ç½®ï¼Œé¿å…è¢«æ£€æµ‹
const requestConfig = {
  osContext: {
    osName: "Mac OS X",
    osVersion: "10.15.7"
  },
  browserContext: {
    browserName: "Chrome",
    browserVersion: "131.0.0.0"
  }
};

// åˆ›å»ºåŒ¿åç”¨æˆ·å¹¶è·å– token
const createAnonymousUser = async () => {
  const response = await fetch(GRAPHQL_URL, {
    method: 'POST',
    headers: FIXED_HEADERS,
    body: JSON.stringify({
      operationName: "CreateAnonymousUser",
      variables: { input: requestConfig },
      query: CREATE_ANONYMOUS_USER_MUTATION
    })
  });
  // è¿”å› JWT token
};
```

### 2. Worker ç®¡ç†å™¨ (`warp_token_manager.py`)

**åŠŸèƒ½**: ç®¡ç† Cloudflare Worker çš„ç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒç±»**: `CloudflareWorkerManager`

```python
class CloudflareWorkerManager:
    def __init__(self, api_token: str, account_id: str):
        self.api_token = api_token
        self.account_id = account_id
        self.subdomain = None  # è‡ªåŠ¨æ£€æµ‹

    async def deploy_worker(self, worker_name: str) -> str:
        """éƒ¨ç½² Worker å¹¶å¯ç”¨ workers.dev è·¯ç”±"""
        # 1. ä¸Šä¼  Worker è„šæœ¬
        # 2. å¯ç”¨ workers.dev è·¯ç”±
        # 3. è¿”å› Worker URL

    async def get_token_from_worker(self, worker_url: str) -> str:
        """ä» Worker è·å– token"""
        # è°ƒç”¨ Worker çš„ /token ç«¯ç‚¹
        # å¤„ç†é‡è¯•é€»è¾‘
```

**å…³é”®ç‰¹æ€§**:
- è‡ªåŠ¨æ£€æµ‹è´¦æˆ· subdomain
- è‡ªåŠ¨å¯ç”¨ workers.dev è·¯ç”±
- Worker ä½¿ç”¨åè‡ªåŠ¨æ¸…ç†
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 3. Token æ± ç®¡ç† (`warp_token_pool.py`)

**åŠŸèƒ½**: ç»´æŠ¤å¤šä¸ªæœ‰æ•ˆ tokenï¼Œæä¾›æ— ç¼åˆ‡æ¢èƒ½åŠ›

**æ ¸å¿ƒç±»**: `WarpTokenPool`

```python
class WarpTokenPool:
    def __init__(self, pool_size: int = 3):
        self.pool_size = pool_size
        self.tokens: List[TokenInfo] = []
        self.lock = asyncio.Lock()
        self.background_task = None

    async def get_valid_token(self) -> str:
        """è·å–ä¸€ä¸ªæœ‰æ•ˆçš„ token"""
        # 1. ä»æ± ä¸­é€‰æ‹©å¯ç”¨ token
        # 2. è½®æ¢ä½¿ç”¨ç­–ç•¥
        # 3. è§¦å‘åå°è¡¥å……

    async def handle_rate_limit(self, failed_token: str) -> Optional[str]:
        """å¤„ç† 429 é”™è¯¯ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨ token"""
        # 1. æ ‡è®°å¤±è´¥ token ä¸ºå—é™
        # 2. è·å–å¤‡ç”¨ token
        # 3. è§¦å‘ç´§æ€¥è¡¥å……
```

**æ± ç®¡ç†ç­–ç•¥**:
- **åˆå§‹åŒ–**: å¯åŠ¨æ—¶åˆ›å»º `pool_size` ä¸ª token
- **è½®æ¢ä½¿ç”¨**: è®°å½•æ¯ä¸ª token ä½¿ç”¨æ¬¡æ•°ï¼Œå‡è¡¡åˆ†é…
- **è‡ªåŠ¨è¡¥å……**: åå°ä»»åŠ¡æ£€æµ‹æ± å¥åº·åº¦ï¼Œè‡ªåŠ¨è¡¥å……
- **429 å¤„ç†**: ç«‹å³åˆ‡æ¢å¤‡ç”¨ tokenï¼Œä¸ä¸­æ–­æœåŠ¡

### 4. è¯·æ±‚æ‹¦æˆªå™¨ (`warp_request_handler.py`)

**åŠŸèƒ½**: æ‹¦æˆª HTTP è¯·æ±‚ï¼Œå¤„ç† 429 é”™è¯¯

**æ ¸å¿ƒç±»**: `WarpRequestHandler`

```python
class WarpRequestHandler:
    def __init__(self, max_retries: int = 3):
        self.max_retries = max_retries
        self.current_token = None
        self.client = httpx.AsyncClient()

    async def make_request(self, method: str, url: str, **kwargs):
        """å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨å¤„ç† 429"""
        for attempt in range(self.max_retries):
            # 1. æ·»åŠ è®¤è¯å¤´
            # 2. å‘é€è¯·æ±‚
            # 3. å¦‚æœ 429ï¼Œåˆ‡æ¢ token å¹¶é‡è¯•
            if response.status_code == 429:
                await self._handle_rate_limit()
                continue
            return response
```

**é‡è¯•ç­–ç•¥**:
1. ç¬¬ä¸€æ¬¡ 429: åˆ‡æ¢åˆ°æ± ä¸­å¤‡ç”¨ token
2. ç¬¬äºŒæ¬¡ 429: è§¦å‘ç´§æ€¥ token è·å–
3. ç¬¬ä¸‰æ¬¡ 429: è¿”å›é”™è¯¯ï¼ˆå·²å°½æœ€å¤§åŠªåŠ›ï¼‰

## é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### 1. è®¤è¯æ¨¡å—é›†æˆ (`warp2protobuf/core/auth.py`)

```python
async def acquire_anonymous_access_token():
    """è·å–åŒ¿åè®¿é—®ä»¤ç‰Œ"""
    # æ£€æŸ¥æ˜¯å¦é…ç½®äº† Cloudflare
    if CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID:
        # ä½¿ç”¨ Token æ± 
        from warp_token_pool import get_pooled_token
        token = await get_pooled_token()
        if token:
            return token

    # å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
    return await _create_anonymous_user()
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

```bash
# Cloudflare é…ç½®ï¼ˆå¯é€‰ï¼‰
export CLOUDFLARE_API_TOKEN="your_api_token"
export CLOUDFLARE_ACCOUNT_ID="your_account_id"

# Token æ± é…ç½®ï¼ˆå¯é€‰ï¼‰
export TOKEN_POOL_SIZE=3  # æ± å¤§å°ï¼Œé»˜è®¤ 3
export TOKEN_REFRESH_INTERVAL=1800  # åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 30 åˆ†é’Ÿ
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘å¤„ç†
- Worker éƒ¨ç½²å¹¶å‘æ‰§è¡Œ
- Token è·å–å¹¶å‘è¯·æ±‚
- åå°ä»»åŠ¡å¼‚æ­¥è¿è¡Œ

### 2. èµ„æºç®¡ç†
- Worker ä½¿ç”¨åç«‹å³åˆ é™¤
- Token è¿‡æœŸè‡ªåŠ¨æ¸…ç†
- å†…å­˜æ± å¤§å°é™åˆ¶

### 3. é”™è¯¯æ¢å¤
- å¤šå±‚é‡è¯•æœºåˆ¶
- é™çº§ç­–ç•¥ï¼ˆCF â†’ ä¼ ç»Ÿæ–¹æ³•ï¼‰
- è¯¦ç»†é”™è¯¯æ—¥å¿—

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬ (`test_token_pool.py`)

æµ‹è¯•è¦†ç›–:
1. âœ… åŸºæœ¬ Token è·å–
2. âœ… Token æ± ç®¡ç†
3. âœ… 429 é”™è¯¯å¤„ç†
4. âœ… è¯·æ±‚å¤„ç†å™¨é›†æˆ
5. âœ… å¹¶å‘è¯·æ±‚å¤„ç†
6. âœ… Warp API è¯·æ±‚

### æµ‹è¯•ç»“æœ
```
æ€»è®¡: 6/6 é¡¹æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Token æ± ç³»ç»Ÿå·¥ä½œæ­£å¸¸
```

## ç›‘æ§å’Œç»Ÿè®¡

### æ± çŠ¶æ€ç»Ÿè®¡

```python
stats = pool.get_stats()
# {
#     'total_requests': 100,        # æ€»è¯·æ±‚æ•°
#     'successful_switches': 5,     # æˆåŠŸåˆ‡æ¢æ¬¡æ•°
#     'tokens_created': 10,         # åˆ›å»ºçš„ token æ•°
#     'rate_limit_hits': 5,         # 429 å‘½ä¸­æ¬¡æ•°
#     'pool_size': 3,              # å½“å‰æ± å¤§å°
#     'valid_tokens': 3,           # æœ‰æ•ˆ token æ•°
#     'average_token_age': 1800.0,  # å¹³å‡ token å¹´é¾„ï¼ˆç§’ï¼‰
# }
```

### æ—¥å¿—è®°å½•

å…³é”®æ—¥å¿—ç‚¹:
- Token æ± å¯åŠ¨/åœæ­¢
- Token åˆ›å»º/åˆ·æ–°/è¿‡æœŸ
- 429 é”™è¯¯å’Œåˆ‡æ¢
- Worker éƒ¨ç½²/åˆ é™¤
- æ€§èƒ½æŒ‡æ ‡

## å·²çŸ¥é™åˆ¶å’Œæœªæ¥æ”¹è¿›

### å½“å‰é™åˆ¶
1. Cloudflare Workers æ¯æ—¥è¯·æ±‚é™åˆ¶ï¼ˆå…è´¹è´¦æˆ· 100k/å¤©ï¼‰
2. Worker éƒ¨ç½²éœ€è¦ Cloudflare è´¦æˆ·
3. Token æ± å¤§å°å—å†…å­˜é™åˆ¶

### æœªæ¥æ”¹è¿›æ–¹å‘
1. **åˆ†å¸ƒå¼ Token æ± **: æ”¯æŒå¤šå®ä¾‹å…±äº« token æ± 
2. **æ™ºèƒ½é¢„æµ‹**: åŸºäºä½¿ç”¨æ¨¡å¼é¢„æµ‹ token éœ€æ±‚
3. **å¤šè´¦æˆ·æ”¯æŒ**: æ”¯æŒå¤šä¸ª Cloudflare è´¦æˆ·è½®æ¢
4. **æŒä¹…åŒ–å­˜å‚¨**: Token æ± æŒä¹…åŒ–ï¼Œé‡å¯åæ¢å¤
5. **ç›‘æ§é¢æ¿**: Web UI æ˜¾ç¤ºæ± çŠ¶æ€å’Œç»Ÿè®¡

## æ€»ç»“

Token æ± ç®¡ç†ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹åˆ›æ–°ç‚¹è§£å†³äº† Warp API è®¿é—®é™åˆ¶é—®é¢˜ï¼š

1. **Cloudflare Worker åˆ†å¸ƒå¼ IP**: çªç ´å• IP é™åˆ¶
2. **Token é¢„å¤‡æ± **: é¿å…å®æ—¶ç”³è¯·å¯¼è‡´çš„å»¶è¿Ÿ
3. **æ— ç¼åˆ‡æ¢**: 429 é”™è¯¯è‡ªåŠ¨å¤„ç†ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
4. **æ™ºèƒ½ç®¡ç†**: è‡ªåŠ¨åˆ·æ–°ã€æ¸…ç†ã€è¡¥å……

è¯¥ç³»ç»Ÿå·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œï¼Œæ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œå°†å¯¹è¯ä¸­æ–­ç‡é™ä½åˆ°æ¥è¿‘ 0%ã€‚